import { GoogleGenAI } from "@google/genai";

// Access API_KEY safely via Vite's define replacement.
// Vite replaces 'process.env.API_KEY' with the actual string value at build time.
const API_KEY = process.env.API_KEY;

if (!API_KEY) {
  console.warn("API Key is missing. Please check your environment variables (.env file or Vercel Dashboard).");
} else {
  console.log("Gemini Service initialized with API Key present.");
}

// Initialize the client. We pass an empty string if undefined to prevent constructor errors,
// though actual API calls will fail if the key is invalid.
const ai = new GoogleGenAI({ apiKey: API_KEY || '' });

export const extractCsvFromPdf = async (base64Pdf: string): Promise<string> => {
  if (!API_KEY) {
    throw new Error("API Key is missing. Please add VITE_API_KEY or API_KEY to your environment variables.");
  }

  try {
    // Using gemini-3-pro-preview as requested for complex reasoning
    // High thinking budget for thorough analysis of messy PDFs
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: {
        parts: [
          {
            inlineData: {
              mimeType: 'application/pdf',
              data: base64Pdf
            }
          },
          {
            text: `You are a PDF-to-Spreadsheet Extractor AI. Your job is to read the entire PDF I upload and convert all of its content into a clean, well-structured spreadsheet table.

RULES:
1. Extract ALL tables, rows, columns, and text-based data.
2. Reconstruct tables even if they are messy, tilted, scanned, or poorly formatted.
3. Remove duplicates, blank rows, repeated headers, watermarks, or irrelevant text.
4. Detect column headers automatically and standardize them.
5. Align all data into a clean row-and-column format suitable for Excel or Google Sheets.
6. If the PDF has multiple tables, combine them into separate labeled sections or merge if they share the same structure.
7. Output MUST be in pure CSV format â€” no commentary, no explanations, no markdown, no code blocks.
8. Only return the CSV content that can be exported directly into a spreadsheet.

If the PDF contains paragraphs, summarize into proper columns. If it contains forms, convert fields into columns. Normalize invoice line items.

Output ONLY raw CSV data.`
          }
        ]
      },
      config: {
        thinkingConfig: {
            thinkingBudget: 32768 // Max budget for gemini-3-pro-preview
        },
      }
    });

    const text = response.text;
    if (!text) {
      throw new Error("No content generated by the model.");
    }

    let cleanedText = text;
    // Improved regex to capture content inside code blocks, handling optional language identifier
    // Matches ```csv ... ```, ``` ... ```, etc.
    const codeBlockMatch = text.match(/```(?:csv|txt)?\s*([\s\S]*?)\s*```/i);
    if (codeBlockMatch) {
      cleanedText = codeBlockMatch[1];
    } else {
        // Fallback: cleanup if no code blocks but still has potential markdown artifacts
        // Remove leading/trailing backticks if they exist
        cleanedText = text.replace(/^```(?:csv)?/i, '').replace(/```$/i, '');
    }
    
    return cleanedText.trim();

  } catch (error: any) {
    console.error("Gemini API Error:", error);
    throw new Error(error.message || "Failed to process PDF");
  }
};

export const fileToBase64 = (file: File): Promise<string> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => {
      const result = reader.result as string;
      // Remove data URL prefix (e.g., "data:application/pdf;base64,")
      const base64 = result.split(',')[1];
      resolve(base64);
    };
    reader.onerror = error => reject(error);
  });
};